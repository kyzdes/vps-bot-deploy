# Методичка: деплой Telegram-ботов на VPS

## Что получится в итоге

Сервер, на котором крутятся твои Telegram-боты. Каждый бот — systemd-сервис (по умолчанию) или Docker-контейнер (через Dokploy). Управление через Claude Code: деплой, логи, обновление, переменные окружения — всё одной командой.

---

## Требования

- **VPS** — Ubuntu 20.04+ (1 GB RAM для systemd-ботов, 2 GB для Dokploy)
- **GitHub** — репо с кодом бота + залогиненный `gh` CLI
- **Claude Code** на локальной машине

Домен и Cloudflare **не нужны** для polling-ботов (большинство ботов).

---

## Фаза 1: Первый бот (полная настройка)

### 1.1. Запусти команду

```
/deploy-bot https://github.com/username/my-bot
```

Или просто `/deploy-bot` — Claude спросит всё сам.

### 1.2. Ответь на вопросы

Claude спросит только:
- **IP сервера** — например `185.123.45.67`
- **Root-пароль** — используется один раз для настройки SSH-ключа, потом не нужен

Можно сразу:
```
IP: 185.123.45.67
Пароль: MySecretPass123
```

### 1.3. Что произойдёт автоматически

Claude:
1. Настроит SSH-ключ (пароль больше не понадобится)
2. Установит базовые пакеты (Python, git, curl)
3. Проанализирует репозиторий:
   - Определит язык (Python, Node.js, Go)
   - Определит базу данных (SQLite, PostgreSQL, нет)
   - Определит тип (polling или webhook)
   - Найдёт нужные переменные окружения
4. Выберет метод деплоя (systemd или Dokploy)
5. Спросит только секреты, которые не может определить сам

### 1.4. Ответь про секреты

```
Нужны значения:
  - BOT_TOKEN — токен Telegram-бота
  - OPENAI_API_KEY — ключ OpenAI

Настройки по умолчанию:
  - PYTHONUNBUFFERED = 1

Бот использует SQLite — внешняя БД не нужна.
```

Дай значения секретов. Остальное заполнится автоматически.

### 1.5. Готово

Claude задеплоит бота, проверит что он работает и покажет статус. Бот отвечает в Telegram.

---

## Фаза 2: Следующие боты

Сервер уже настроен. Claude помнит конфигурацию.

```
/deploy-bot https://github.com/username/another-bot
```

Claude пропустит настройку сервера, сразу перейдёт к анализу репо → секреты → деплой.

---

## Фаза 3: Управление ботами

| Команда | Что делает |
|---------|------------|
| `/manage-bot` | Статус всех ботов |
| `/manage-bot logs my-bot` | Логи бота |
| `/manage-bot redeploy my-bot` | Обновить из git (pull + перезапуск) |
| `/manage-bot env my-bot` | Посмотреть/изменить переменные |
| `/manage-bot stop my-bot` | Остановить |
| `/manage-bot start my-bot` | Запустить |
| `/manage-bot delete my-bot` | Удалить полностью |

Все команды работают одинаково для systemd и Dokploy ботов — Claude сам определяет метод из конфигурации.

---

## Методы деплоя

### systemd (по умолчанию)

Бот работает напрямую на сервере как системный сервис:
- Код в `/opt/<имя-бота>/`
- Виртуальное окружение Python (или node_modules) рядом
- `.env` файл с переменными
- Логи через `journalctl`
- Автозапуск при перезагрузке сервера

**Когда подходит:** polling-боты, SQLite, простые проекты.

**Преимущества:** не нужен Docker, быстрее стартует, меньше потребляет RAM.

### Dokploy (опционально)

Бот работает в Docker-контейнере через Dokploy:
- Traefik для HTTPS и маршрутизации
- Общий PostgreSQL и Redis (создаются только если нужны)
- Автодеплой через вебхуки GitHub

**Когда подходит:** webhook-боты, проекты с PostgreSQL/Redis.

**Преимущества:** изоляция, автоматический SSL, контейнеризация.

### Как выбирается

| База данных | Тип бота | Метод |
|-------------|----------|-------|
| SQLite / нет | polling | **systemd** |
| SQLite / нет | webhook | dokploy |
| PostgreSQL | любой | dokploy |

Claude предложит подходящий метод, но ты всегда можешь переопределить.

---

## Подготовка репозитория

### Минимально

Бот должен работать — этого достаточно. Claude определит остальное.

### Рекомендуется

**`.env.example`** — список переменных окружения:

```env
# Telegram
BOT_TOKEN=

# Внешние сервисы (если есть)
OPENAI_API_KEY=

# Логирование
PYTHONUNBUFFERED=1
LOG_LEVEL=info
```

Это главный способ для Claude понять, какие переменные нужны.

**`Dockerfile`** — для Dokploy-деплоя. Если нет, Claude либо создаст автоматически, либо использует nixpacks. Для systemd-деплоя Dockerfile не нужен.

### Команда `/prepare-bot`

Если хочешь заранее подготовить репо:

```
/prepare-bot https://github.com/username/my-bot
```

Claude проанализирует репозиторий и предложит:
- Добавить Dockerfile (если нет)
- Создать `.env.example`
- Вынести захардкоженные пути в переменные окружения

---

## Что делать если...

### Бот не запускается

```
/manage-bot logs my-bot
```

Частые причины: неправильный токен, отсутствующая переменная, ошибка в коде.

### Нужно обновить токен/секрет

```
/manage-bot env my-bot
```

Claude покажет текущие переменные и поможет изменить.

### Запушил изменения в GitHub

```
/manage-bot redeploy my-bot
```

Для systemd: `git pull` + переустановка зависимостей + перезапуск.
Для Dokploy: пересборка Docker-образа.

### Docker Hub не работает (rate limit)

Claude определит это автоматически и предложит переключиться на systemd. Systemd не зависит от Docker Hub.

### На сервере уже стоит Dokploy

Claude определит это и не будет пытаться ставить заново. Попросит API-ключ существующей установки.

### Бот использует SQLite

Всё работает из коробки. SQLite-файл хранится рядом с кодом в `/opt/<имя-бота>/`. Для Dokploy нужен Docker volume.

### Хочу отдельную базу для бота

По умолчанию PostgreSQL/Redis создаются общие (если вообще нужны). Скажи Claude при деплое, если нужна отдельная.

---

## Архитектура

### systemd-бот

```
VPS
├── /opt/my-bot/
│   ├── .venv/           # виртуальное окружение
│   ├── .env             # переменные (chmod 600)
│   ├── bot/             # код из git
│   └── data/bot.db      # SQLite (если есть)
├── /etc/systemd/system/my-bot.service
└── journalctl -u my-bot  # логи
```

### Dokploy-бот

```
VPS
├── Dokploy (управление контейнерами)
│   ├── Traefik (reverse proxy + SSL)
│   ├── [PostgreSQL] (только если нужен)
│   ├── [Redis] (только если нужен)
│   ├── my-bot (контейнер)
│   └── another-bot (контейнер)
└── dokploy-network (все контейнеры видят друг друга)
```

### Конфигурация

Вся конфигурация хранится в `~/.claude/projects/<project>/memory/deploy-config.md`:
- Данные сервера (IP, SSH)
- Dokploy (если используется): URL, API-ключ, project ID
- Список ботов: имя, метод, тип, репо, дата деплоя

---

## Сколько ботов потянет сервер

| Конфигурация | systemd-боты | Dokploy-боты |
|-------------|-------------|-------------|
| 1 GB RAM | 5-8 polling | не рекомендуется |
| 2 GB RAM | 10-15 polling | 5-8 |
| 4 GB RAM | 20+ polling | 10-15 |

Polling-боты через systemd потребляют 30-80 MB каждый. Dokploy + PostgreSQL + Redis забирают ~500 MB базово.
